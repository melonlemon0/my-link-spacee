<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Link Space</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
    }

    body {
      background: #ffffff;
      color: #111827;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .app-shell {
      display: flex;
      flex-direction: column;
      height: 100vh;
      width: 100vw;
    }

    /* Header */
    .app-header {
      padding: 14px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      background: #ffffff;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .app-title {
      font-size: 20px;
      font-weight: 600;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }

    .badge-code {
      padding: 4px 10px;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid #4f46e5;
      color: #4f46e5;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 12px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      background: #4b5563;
      color: #f9fafb;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      justify-content: center;
    }

    .btn:hover {
      background: #374151;
    }

    .btn-primary {
      background: #4f46e5;
      color: #eef2ff;
    }

    .btn-primary:hover {
      background: #4338ca;
    }

    .btn-icon {
      border-radius: 999px;
      height: 40px;
      width: 40px;
      padding: 0;
      justify-content: center;
      font-size: 22px;
    }

    /* Main area */
    .app-main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 20px 20px;
      gap: 16px;
      overflow: hidden;
      background: #f9fafb;
    }

    /* Login panel */
    #login-section {
      margin: auto;
      max-width: 420px;
      width: 100%;
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 20px 20px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 12px 30px rgba(0,0,0,0.05);
      text-align: center;
    }

    .login-emoji {
      font-size: 64px; /* big coffee emoji */
      margin-bottom: 10px;
    }

    .login-title {
      margin: 0 0 6px;
      font-size: 20px;
      font-weight: 600;
    }

    .login-format {
      margin: 4px 0 16px;
      font-size: 13px;
      color: #6b7280;
    }

    label {
      display: none;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid #d1d5db;
      background: #ffffff;
      color: #111827;
      font-size: 16px;
      outline: none;
      transition: border-color 0.15s, box-shadow 0.15s;
    }

    #access-code {
      text-align: center;
      letter-spacing: 2px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
    }

    input[type="text"]::placeholder {
      color: #d1d5db;
    }

    input[type="text"]:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 2px rgba(129,140,248,0.3);
    }

    .error-text {
      font-size: 12px;
      color: #b91c1c;
      margin: 8px 0 0;
    }

    /* App content when logged in */
    #app-section {
      display: none;
      height: 100%;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .top-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-width: 820px;
      width: 100%;
      margin: 0 auto;
    }

    .input-row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .input-row > input {
      flex: 1;
    }

    .hint-row {
      font-size: 12px;
      color: #6b7280;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      min-height: 18px;
    }

    .edit-pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #ecfdf3;
      color: #15803d;
      border: 1px solid #bbf7d0;
    }

    .cancel-edit {
      background: transparent;
      border-radius: 999px;
      border: none;
      color: #b91c1c;
      font-size: 11px;
      cursor: pointer;
      text-decoration: underline;
      margin-left: 6px;
    }

    /* URL / title inputs */
    #url-input,
    #title-input {
      padding: 9px 11px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      font-size: 14px;
      background: #ffffff;
      color: #111827;
      outline: none;
    }

    #url-input::placeholder,
    #title-input::placeholder {
      color: #9ca3af;
    }

    #url-input:focus,
    #title-input:focus {
      border-color: #6366f1;
      box-shadow: 0 0 0 1px rgba(129,140,248,0.2);
    }

    /* List panel */
    .list-panel {
      flex: 1;
      max-width: 820px;
      width: 100%;
      margin: 0 auto;
      background: transparent;
      border-radius: 16px;
      padding: 4px 2px 4px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 6px;
      padding: 0 4px;
    }

    .list-header-title {
      font-size: 13px;
      color: #374151;
    }

    .list-header-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .links-list {
      margin-top: 4px;
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      overflow-y: auto;
      padding: 4px;
    }

    .links-list::-webkit-scrollbar {
      width: 6px;
    }
    .links-list::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 999px;
    }

    /* Cute rectangular cards */
    .link-card {
      display: flex;
      flex-direction: column;
      padding: 8px 9px;
      border-radius: 16px;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      box-shadow: 0 4px 10px rgba(15,23,42,0.06);
      gap: 6px;
      min-height: 78px;
      cursor: grab;
    }

    .link-card:active {
      cursor: grabbing;
    }

    .link-main {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
      text-decoration: none;
      color: inherit;
    }

    .preview-box {
      height: 26px;
      width: 26px;
      border-radius: 999px;
      background: rgba(255,255,255,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid rgba(255,255,255,0.8);
      flex-shrink: 0;
    }

    .preview-box img {
      width: 16px;
      height: 16px;
    }

    .meta {
      min-width: 0;
    }

    .meta-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .meta .title {
      font-size: 13px;
      font-weight: 600;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      color: #111827;
    }

    .meta .url {
      font-size: 11px;
      color: #4b5563;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }

    .actions {
      display: flex;
      gap: 4px;
      justify-content: flex-end;
      margin-top: 2px;
    }

    .small-btn {
      padding: 3px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #374151;
      cursor: pointer;
      white-space: nowrap;
    }

    .small-btn:hover {
      background: #e5e7eb;
    }

    .small-btn.danger {
      border-color: #fecaca;
      color: #b91c1c;
      background: #fef2f2;
    }

    .small-btn.danger:hover {
      background: #fee2e2;
    }

    .empty {
      font-size: 13px;
      color: #9ca3af;
      text-align: center;
      padding: 18px 0;
    }

    @media (max-width: 900px) {
      .links-list {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 640px) {
      .app-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }
      .app-main {
        padding: 12px 12px 16px;
      }
      .top-row,
      .list-panel {
        width: 100%;
        max-width: none;
      }
      .links-list {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 480px) {
      .links-list {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div>
        <div class="app-title">My Link Space</div>
      </div>
      <div class="header-right" id="header-right">
        <!-- filled dynamically -->
      </div>
    </header>

    <main class="app-main">
      <!-- LOGIN VIEW -->
      <section id="login-section">
        <div class="login-emoji">☕</div>
        <h2 class="login-title">Access code</h2>
        <form id="login-form">
          <input
            type="text"
            id="access-code"
            maxlength="7"
            autocomplete="off"
            placeholder="1234ABC"
          />
          <p class="login-format">Format: 4 digits + 3 letters (e.g., 1234ABC)</p>
          <p id="login-error" class="error-text" style="display:none;"></p>
          <button class="btn btn-primary" type="submit" style="margin-top:14px;width:100%;font-size:15px;padding:10px 14px;">
            Enter
          </button>
        </form>
      </section>

      <!-- APP VIEW -->
      <section id="app-section">
        <!-- Top row: URL + Title inputs -->
        <div class="top-row">
          <div class="input-row">
            <input
              type="text"
              id="url-input"
              placeholder="Paste or type a URL, e.g. https://google.com/search?q=..."
            />
            <button class="btn btn-primary btn-icon" id="add-btn" title="Add link">+</button>
          </div>
          <input
            type="text"
            id="title-input"
            placeholder="Optional title (e.g. Study Timer, YouTube Music, Pomodoro)"
          />
          <div class="hint-row">
            <span id="edit-status" style="display:none; align-items:center;">
              <span class="edit-pill">Editing link</span>
              <button type="button" class="cancel-edit" id="cancel-edit-btn">cancel</button>
            </span>
          </div>
        </div>

        <!-- List panel -->
        <div class="list-panel">
          <div class="list-header">
            <div class="list-header-title">Saved links</div>
            <div class="list-header-sub">Drag cards to reorder</div>
          </div>
          <div id="links-list" class="links-list">
            <!-- link cards go here -->
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // === SUPABASE CONFIG (your actual project) ===
    const SUPABASE_URL = "https://upiobealvympxbypfmkc.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwaW9iZWFsdnltcHhieXBmbWtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMzNzYxNDIsImV4cCI6MjA3ODk1MjE0Mn0.mLvGyy-eMWr-ow2b2USMg7PXKq2EUfK1fyJEsdGThKw";

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // STATE
    let currentCode = null;
    let editingId = null;
    let linksData = [];
    let dragIndex = null;

    // ELEMENTS
    const loginSection = document.getElementById("login-section");
    const appSection = document.getElementById("app-section");
    const loginForm = document.getElementById("login-form");
    const loginError = document.getElementById("login-error");
    const accessCodeInput = document.getElementById("access-code");
    const urlInput = document.getElementById("url-input");
    const titleInput = document.getElementById("title-input");
    const addBtn = document.getElementById("add-btn");
    const linksList = document.getElementById("links-list");
    const headerRight = document.getElementById("header-right");
    const editStatus = document.getElementById("edit-status");
    const cancelEditBtn = document.getElementById("cancel-edit-btn");

    const pastelPalette = [
      { bg: "#fef3c7", border: "#fde68a" },
      { bg: "#e0f2fe", border: "#bae6fd" },
      { bg: "#fce7f3", border: "#f9a8d4" },
      { bg: "#dcfce7", border: "#bbf7d0" },
      { bg: "#ede9fe", border: "#ddd6fe" },
      { bg: "#fee2e2", border: "#fecaca" },
      { bg: "#dbeafe", border: "#bfdbfe" }
    ];

    function validateCode(code) {
      return /^\d{4}[A-Za-z]{3}$/.test(code);
    }

    function normalizeUrl(url) {
      let trimmed = url.trim();
      if (!trimmed) return "";
      if (!/^https?:\/\//i.test(trimmed)) {
        trimmed = "https://" + trimmed;
      }
      return trimmed;
    }

    function getDomain(url) {
      try {
        return new URL(url).hostname;
      } catch {
        return url;
      }
    }

    function displayUrl(url) {
      try {
        const u = new URL(url);
        let path = u.pathname + u.search;
        if (path === "/" || path === "") path = "";
        if (path.length > 30) path = path.slice(0, 27) + "...";
        return u.hostname + (path ? path : "");
      } catch {
        return url.length > 40 ? url.slice(0, 37) + "..." : url;
      }
    }

    function faviconUrl(url) {
      const domain = getDomain(url);
      return "https://www.google.com/s2/favicons?sz=64&domain=" + encodeURIComponent(domain);
    }

    function autoTitleFromUrl(url) {
      try {
        const u = new URL(url);
        return u.hostname;
      } catch {
        return url;
      }
    }

    function getPastelForLink(link) {
      const key = (getDomain(link.url) || "") + "|" + (link.title || "");
      let hash = 0;
      for (let i = 0; i < key.length; i++) {
        hash = (hash + key.charCodeAt(i) * (i + 1)) % pastelPalette.length;
      }
      return pastelPalette[hash] || pastelPalette[0];
    }

    function setLoggedOutUI() {
      headerRight.innerHTML = `
        <span style="font-size:13px;color:#6b7280;">Not logged in</span>
      `;
    }

    function setLoggedInUI(code) {
      headerRight.innerHTML = `
        <span class="badge-code">${code}</span>
        <button class="btn" id="logout-btn">Log out</button>
      `;
      document.getElementById("logout-btn").addEventListener("click", () => {
        location.reload();
      });
    }

    function setEditingMode(on) {
      if (on) {
        addBtn.textContent = "✓";
        addBtn.title = "Save changes";
        editStatus.style.display = "inline-flex";
      } else {
        addBtn.textContent = "+";
        addBtn.title = "Add link";
        editStatus.style.display = "none";
        editingId = null;
      }
    }

    function showLogin() {
      loginSection.style.display = "block";
      appSection.style.display = "none";
      setLoggedOutUI();
    }

    function showApp() {
      loginSection.style.display = "none";
      appSection.style.display = "flex";
    }

    function renderLinks(list) {
      linksList.innerHTML = "";
      if (!list || !list.length) {
        linksList.innerHTML = `<div class="empty">No links yet. Add one above with the + button.</div>`;
        return;
      }

      list.forEach((link, index) => {
        const card = document.createElement("div");
        card.className = "link-card";
        card.setAttribute("draggable", "true");
        card.dataset.index = index;

        const domain = getDomain(link.url);
        const display = displayUrl(link.url);
        const titleText = (link.title && link.title.trim()) ? link.title : domain;
        const pastel = getPastelForLink(link);

        card.style.background = pastel.bg;
        card.style.borderColor = pastel.border;

        card.innerHTML = `
          <a href="${link.url}" target="_blank" rel="noopener noreferrer" class="link-main">
            <div class="preview-box">
              <img src="${faviconUrl(link.url)}" alt="${domain}" />
            </div>
            <div class="meta">
              <div class="meta-header">
                <div class="title">${titleText}</div>
              </div>
              <div class="url">${display}</div>
            </div>
          </a>
          <div class="actions">
            <button class="small-btn edit-btn">Edit</button>
            <button class="small-btn danger delete-btn">Delete</button>
          </div>
        `;

        card.addEventListener("dragstart", (e) => {
          dragIndex = index;
          e.dataTransfer.effectAllowed = "move";
        });

        card.addEventListener("dragover", (e) => {
          e.preventDefault();
        });

        card.addEventListener("drop", async (e) => {
          e.preventDefault();
          const targetIndex = Number(card.dataset.index);
          if (dragIndex === null || dragIndex === targetIndex) return;

          const moved = linksData.splice(dragIndex, 1)[0];
          linksData.splice(targetIndex, 0, moved);
          dragIndex = null;

          await saveOrder();
          renderLinks(linksData);
        });

        const editBtn = card.querySelector(".edit-btn");
        const deleteBtn = card.querySelector(".delete-btn");

        editBtn.addEventListener("click", () => {
          editingId = link.id;
          urlInput.value = link.url;
          titleInput.value = link.title || "";
          urlInput.focus();
          setEditingMode(true);
        });

        deleteBtn.addEventListener("click", async () => {
          const ok = confirm("Delete this link?");
          if (!ok) return;
          const { error } = await db
            .from("links")
            .delete()
            .eq("id", link.id)
            .eq("code", currentCode);
          if (error) {
            console.error("Error deleting link:", error);
            alert("Error deleting link: " + error.message);
          } else {
            fetchLinks();
          }
        });

        linksList.appendChild(card);
      });
    }

    async function saveOrder() {
      const updates = linksData.map((link, index) => ({
        id: link.id,
        order_index: index
      }));

      const { error } = await db
        .from("links")
        .upsert(updates, { onConflict: "id" });

      if (error) {
        console.error("Error saving order:", error);
      }
    }

    async function fetchLinks() {
      if (!currentCode) return;
      linksList.innerHTML = `<div class="empty">Loading...</div>`;
      const { data, error } = await db
        .from("links")
        .select("*")
        .eq("code", currentCode);

      if (error) {
        console.error("Error loading links:", error);
        linksList.innerHTML = `<div class="empty">Error loading links.</div>`;
        return;
      }

      linksData = (data || []).sort((a, b) => {
        const ai = (a.order_index === null || a.order_index === undefined) ? Number.MAX_SAFE_INTEGER : a.order_index;
        const bi = (b.order_index === null || b.order_index === undefined) ? Number.MAX_SAFE_INTEGER : b.order_index;
        if (ai !== bi) return ai - bi;
        return new Date(b.created_at) - new Date(a.created_at);
      });

      renderLinks(linksData);
    }

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      let code = accessCodeInput.value.trim();
      code = code.slice(0, 4) + code.slice(4).toUpperCase();
      accessCodeInput.value = code;

      if (!validateCode(code)) {
        loginError.textContent = "Code must be 4 digits followed by 3 letters (e.g. 1234ABC).";
        loginError.style.display = "block";
        return;
      }

      loginError.style.display = "none";
      currentCode = code;
      setLoggedInUI(code);
      showApp();
      fetchLinks();
      urlInput.focus();
    });

    addBtn.addEventListener("click", async () => {
      if (!currentCode) {
        alert("No active space code.");
        return;
      }
      let url = normalizeUrl(urlInput.value);
      if (!url) return;

      let title = titleInput.value.trim();
      if (!title) title = autoTitleFromUrl(url);

      if (editingId) {
        const { error } = await db
          .from("links")
          .update({ url, title })
          .eq("id", editingId)
          .eq("code", currentCode);
        if (error) {
          console.error("Error updating link:", error);
          alert("Error updating link: " + error.message);
          return;
        }
      } else {
        const maxOrder = linksData.reduce(
          (m, link) =>
            link.order_index !== null &&
            link.order_index !== undefined &&
            link.order_index > m
              ? link.order_index
              : m,
          -1
        );
        const newOrder = maxOrder + 1;

        const { data, error } = await db
          .from("links")
          .insert({ code: currentCode, url, title, order_index: newOrder })
          .select();

        if (error) {
          console.error("Error adding link:", error);
          alert("Error adding link: " + error.message);
          return;
        }
        if (data && data.length) {
          linksData.push(data[0]);
        }
      }

      urlInput.value = "";
      titleInput.value = "";
      setEditingMode(false);
      fetchLinks();
    });

    urlInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addBtn.click();
      }
    });

    titleInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addBtn.click();
      }
    });

    cancelEditBtn.addEventListener("click", () => {
      urlInput.value = "";
      titleInput.value = "";
      setEditingMode(false);
    });

    setLoggedOutUI();
    showLogin();
  </script>
</body>
</html>
